import { getDbPool, initSchema } from '../lib/db.js';

async function updateDatabase() {
  try {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
    
    const pool = getDbPool();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ö–µ–º—É (—Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–ª–µ–º email_sent)
    await initSchema();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ email_sent –≤ —Ç–∞–±–ª–∏—Ü–µ orders
    const [columns] = await pool.query(`
      SELECT COLUMN_NAME 
      FROM INFORMATION_SCHEMA.COLUMNS 
      WHERE TABLE_SCHEMA = DATABASE() 
      AND TABLE_NAME = 'orders' 
      AND COLUMN_NAME = 'email_sent'
    `);
    
    if (columns.length === 0) {
      console.log('üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è email_sent –∫ —Ç–∞–±–ª–∏—Ü–µ orders...');
      await pool.query(`
        ALTER TABLE orders 
        ADD COLUMN email_sent BOOLEAN DEFAULT FALSE
      `);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º email_sent = TRUE –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
      // (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
      await pool.query(`
        UPDATE orders 
        SET email_sent = TRUE 
        WHERE email_sent IS NULL OR email_sent = FALSE
      `);
      
      console.log('‚úÖ –ü–æ–ª–µ email_sent –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    } else {
      console.log('‚úÖ –ü–æ–ª–µ email_sent —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    }
    
    console.log('üéâ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    process.exit(0);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
    process.exit(1);
  }
}

updateDatabase();

